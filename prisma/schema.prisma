// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum PlanType {
  FREE
  PRO
  PREMIUM
}

enum LearningToolType {
  ORGANIZED_NOTE
  QUIZ
  FLASHCARDS
  SUMMARY
}

enum LearningToolSource {
  SUBJECT
  SINGLE_NOTE
}

// Models
model Plan {
  id                String    @id @default(uuid())
  name              String    @unique
  planType          PlanType  @unique
  displayName       String    @map("display_name")
  description       String?
  monthlyPrice      Float     @map("monthly_price")
  yearlyPrice       Float     @map("yearly_price")
  monthlyPriceId    String?   @map("monthly_price_id") // For payment provider reference
  yearlyPriceId     String?   @map("yearly_price_id") // For payment provider reference
  dailyCredits      Int       @map("daily_credits")
  notesLimit        Int       @map("notes_limit") // -1 for unlimited
  subjectsLimit     Int       @map("subjects_limit") // -1 for unlimited
  features          String[]  // Array of feature strings
  isActive          Boolean   @default(true) @map("is_active")
  sortOrder         Int       @default(0) @map("sort_order") // For display ordering
  isMostPopular     Boolean   @default(false) @map("is_most_popular")
  discountPercent   Float?    @map("discount_percent") // Optional promotional discount
  discountLabel     String?   @map("discount_label") // e.g., "50% OFF for Early Users"
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  @@map("plans")
}

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  planType              PlanType  @default(FREE) @map("plan_type")
  notesLimit            Int       @default(50) @map("notes_limit")
  subjectsLimit         Int       @default(10) @map("subjects_limit")
  dailyCredits          Int       @default(10) @map("daily_credits")
  creditsUsedToday      Int       @default(0) @map("credits_used_today")
  lastCreditReset       DateTime  @default(now()) @map("last_credit_reset")
  subscriptionStatus    String?   @default("inactive") @map("subscription_status")
  subscriptionPeriod    String?   @map("subscription_period")
  subscriptionStartDate DateTime? @map("subscription_start_date")
  subscriptionEndDate   DateTime? @map("subscription_end_date")
  isEarlyUser           Boolean   @default(false) @map("is_early_user") // First 50 users flag
  earlyUserNumber       Int?      @map("early_user_number") // Sequential number for early users (1-50)
  adminDiscountPercent  Float?    @map("admin_discount_percent") // Admin-granted discount
  adminNotes            String?   @map("admin_notes") @db.Text // Admin notes about user
  marketingOptIn        Boolean   @default(true) @map("marketing_opt_in") // Marketing emails consent
  lastMarketingEmailAt  DateTime? @map("last_marketing_email_at")
  currentStreak         Int       @default(0) @map("current_streak") // Current consecutive days of activity
  longestStreak         Int       @default(0) @map("longest_streak") // Longest streak ever achieved
  lastActivityDate      DateTime? @map("last_activity_date") // Last date user had activity
  acceptedTerms         Boolean   @default(false) @map("accepted_terms") // Terms and conditions acceptance
  acceptedPrivacy       Boolean   @default(false) @map("accepted_privacy") // Privacy policy acceptance
  termsAcceptedAt       DateTime? @map("terms_accepted_at") // When T&C was accepted
  privacyAcceptedAt     DateTime? @map("privacy_accepted_at") // When privacy policy was accepted
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  subjects              Subject[]
  
  @@index([isEarlyUser])
  @@index([createdAt])
  @@map("users")
}

model Subject {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  title           String
  description     String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes           Note[]
  learningTools   LearningTool[]
  
  @@index([userId])
  @@map("subjects")
}

model Note {
  id                    String    @id @default(uuid())
  subjectId             String    @map("subject_id")
  title                 String
  rawContent            String    @map("raw_content") @db.Text
  knowledgeBase         String?   @map("knowledge_base") @db.Text
  aiProcessedContent    String?   @map("ai_processed_content") @db.Text
  fileUrl               String?   @map("file_url")
  fileName              String?   @map("file_name")
  fileSize              Int?      @map("file_size")
  fileType              String?   @map("file_type")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  subject               Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  learningTools         LearningTool[]
  learningToolNotes     LearningToolNote[]
  
  @@index([subjectId])
  @@map("notes")
}

model LearningTool {
  id                String              @id @default(uuid())
  type              LearningToolType
  source            LearningToolSource
  subjectId         String?             @map("subject_id")
  noteId            String?             @map("note_id")
  generatedContent  String              @map("generated_content") @db.Text
  createdAt         DateTime            @default(now()) @map("created_at")
  
  subject           Subject?            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  note              Note?               @relation(fields: [noteId], references: [id], onDelete: Cascade)
  notes             LearningToolNote[]
  
  @@index([subjectId])
  @@index([noteId])
  @@map("learning_tools")
}

// Junction table for many-to-many relationship between LearningTool and Note
// Used when generating learning tools from multiple selected notes at subject level
model LearningToolNote {
  learningToolId  String   @map("learning_tool_id")
  noteId          String   @map("note_id")
  
  learningTool    LearningTool @relation(fields: [learningToolId], references: [id], onDelete: Cascade)
  note            Note         @relation(fields: [noteId], references: [id], onDelete: Cascade)
  
  @@id([learningToolId, noteId])
  @@index([learningToolId])
  @@index([noteId])
  @@map("learning_tool_notes")
}

// Promo codes for special offers (e.g., Product Hunt, early adopters)
model PromoCode {
  id                String    @id @default(uuid())
  code              String    @unique // e.g., "EARLYCAT50", "PRODUCTHUNT"
  description       String    // e.g., "3 months free for Product Hunt users"
  discountType      String    // "MONTHS_FREE", "PERCENTAGE", "FIXED_AMOUNT"
  discountValue     Float     // Months, percentage, or amount depending on type
  maxUses           Int?      @map("max_uses") // null for unlimited
  currentUses       Int       @default(0) @map("current_uses")
  expiresAt         DateTime? @map("expires_at")
  isActive          Boolean   @default(true) @map("is_active")
  applicablePlans   String[]  @map("applicable_plans") // Array of plan types: ["PRO", "PREMIUM"] or empty for all
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  @@index([code])
  @@index([isActive])
  @@map("promo_codes")
}
